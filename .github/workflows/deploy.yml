name: Deploy FastAPI to VM

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      # Optional sanity check: run tests, flake8, etc.
      # - name: Run tests
      #   run: |
      #     python -m pip install --upgrade pip
      #     python -m pip install -r requirements.txt
      #     pytest

      - name: SSH & deploy on VM
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.VM_HOST }}
          username: ${{ secrets.VM_USER }}       # "ubuntu"
          key: ${{ secrets.VM_SSH_KEY }}        # private key for SSH to VM
          port: 22
          command_timeout: 20m
          script: |
            set -euo pipefail

            APP_ROOT="/var/www"
            APP_NAME="fastapi-backend"
            APP_DIR="${APP_ROOT}/${APP_NAME}"
            REPO_URL="git@github.com:alexansaa/testBackPyTemplate.git"
            BRANCH="main"

            echo "[DEPLOY] Ensuring base directory ${APP_ROOT} exists..."
            sudo mkdir -p "${APP_ROOT}"
            sudo chown "$USER:$USER" "${APP_ROOT}"

            if [ ! -d "${APP_DIR}/.git" ]; then
              echo "[DEPLOY] Cloning repository for the first time..."
              cd "${APP_ROOT}"
              git clone "${REPO_URL}" "${APP_NAME}"
            else
              echo "[DEPLOY] Repository already exists."
            fi

            cd "${APP_DIR}"

            echo "[DEPLOY] Force sync to origin/${BRANCH}..."
            git fetch origin "${BRANCH}"
            git checkout "${BRANCH}" || git checkout -b "${BRANCH}" "origin/${BRANCH}"
            git reset --hard "origin/${BRANCH}"
            git clean -fd
            echo "[DEPLOY] Repository is now clean and matches origin/${BRANCH}"

            echo "[DEPLOY] Creating venv if needed..."
            if [ ! -d ".venv" ]; then
              python3 -m venv .venv
            fi

            echo "[DEPLOY] Installing dependencies..."
            . .venv/bin/activate
            pip install --upgrade pip
            pip install -r requirements.txt

            echo "[DEPLOY] Restarting FastAPI systemd service..."
            sudo systemctl restart fastapi-backend.service

            echo "[DEPLOY] âœ… Deployment completed."
